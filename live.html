<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sapsap - Live Group Video Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .app-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .groups-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .video-section {
            flex: 2;
            min-width: 500px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #6e8efb;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .groups-list {
            display: grid;
            gap: 15px;
        }
        
        .group-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .group-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #6e8efb;
        }
        
        .group-item.active {
            border-color: #6e8efb;
            background: #eef2ff;
        }
        
        .group-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6e8efb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .group-name {
            font-weight: 600;
        }
        
        .group-count {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .group-count.full {
            background: #ff6b6b;
            color: white;
        }
        
        .video-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }
        
        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .control-btn {
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            transform: scale(1.1);
            background: #5a7dfa;
        }
        
        .control-btn.muted {
            background: #ff6b6b;
        }
        
        .control-btn.leave {
            background: #ff6b6b;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .video-section, .groups-section {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sapsap</h1>
            <p>Connect instantly with small groups for live video chats</p>
        </header>
        
        <div class="app-container">
            <section class="groups-section">
                <h2 class="section-title">Available Groups</h2>
                <div class="groups-list" id="groupsList">
                    <!-- Groups will be populated by JavaScript -->
                </div>
            </section>
            
            <section class="video-section">
                <h2 class="section-title">Video Call</h2>
                <div class="video-container" id="videoContainer">
                    <div class="empty-state" id="emptyState">
                        <i>ðŸ“¹</i>
                        <p>Select a group to start a video chat</p>
                    </div>
                </div>
                
                <div class="controls" id="controls" style="display: none;">
                    <button class="control-btn" id="muteAudio">
                        <i>ðŸŽ¤</i>
                    </button>
                    <button class="control-btn" id="muteVideo">
                        <i>ðŸ“¹</i>
                    </button>
                    <button class="control-btn leave" id="leaveCall">
                        <i>ðŸ“ž</i>
                    </button>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Configuration
        const MAX_GROUP_SIZE = 3;
        const SERVER_URL = 'wss://sapsap-signaling-server.glitch.me'; // Using a free WebSocket server
        
        // Application state
        let currentGroup = null;
        let localStream = null;
        let peers = {};
        let socket = null;
        let isAudioMuted = false;
        let isVideoMuted = false;
        
        // DOM elements
        const groupsList = document.getElementById('groupsList');
        const videoContainer = document.getElementById('videoContainer');
        const emptyState = document.getElementById('emptyState');
        const controls = document.getElementById('controls');
        const muteAudioBtn = document.getElementById('muteAudio');
        const muteVideoBtn = document.getElementById('muteVideo');
        const leaveCallBtn = document.getElementById('leaveCall');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            // Connect to signaling server
            connectToSignalingServer();
            
            // Set up event listeners for controls
            muteAudioBtn.addEventListener('click', toggleAudio);
            muteVideoBtn.addEventListener('click', toggleVideo);
            leaveCallBtn.addEventListener('click', leaveCall);
            
            // Load initial groups
            loadGroups();
        }
        
        function connectToSignalingServer() {
            socket = new WebSocket(SERVER_URL);
            
            socket.onopen = () => {
                console.log('Connected to signaling server');
            };
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleSignalingMessage(message);
            };
            
            socket.onclose = () => {
                console.log('Disconnected from signaling server');
                // Try to reconnect after 3 seconds
                setTimeout(connectToSignalingServer, 3000);
            };
        }
        
        function handleSignalingMessage(message) {
            switch (message.type) {
                case 'group-list':
                    updateGroupsList(message.groups);
                    break;
                case 'user-joined':
                    handleUserJoined(message.userId, message.groupId);
                    break;
                case 'user-left':
                    handleUserLeft(message.userId, message.groupId);
                    break;
                case 'offer':
                    handleOffer(message.offer, message.from);
                    break;
                case 'answer':
                    handleAnswer(message.answer, message.from);
                    break;
                case 'ice-candidate':
                    handleIceCandidate(message.candidate, message.from);
                    break;
            }
        }
        
        function loadGroups() {
            // Request group list from server
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'get-groups' }));
            }
        }
        
        function updateGroupsList(groups) {
            groupsList.innerHTML = '';
            
            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                if (currentGroup && currentGroup.id === group.id) {
                    groupItem.classList.add('active');
                }
                
                const isFull = group.participants.length >= MAX_GROUP_SIZE;
                
                groupItem.innerHTML = `
                    <div class="group-info">
                        <div class="group-avatar">${group.name.charAt(0)}</div>
                        <div class="group-name">${group.name}</div>
                    </div>
                    <div class="group-count ${isFull ? 'full' : ''}">
                        ${group.participants.length}/${MAX_GROUP_SIZE}
                    </div>
                `;
                
                if (!isFull) {
                    groupItem.addEventListener('click', () => joinGroup(group.id));
                }
                
                groupsList.appendChild(groupItem);
            });
        }
        
        async function joinGroup(groupId) {
            if (currentGroup) {
                await leaveCall();
            }
            
            // Request to join the group
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ 
                    type: 'join-group', 
                    groupId: groupId 
                }));
                
                currentGroup = { id: groupId };
                
                // Get user media
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    // Show local video
                    showLocalVideo();
                    
                    // Show controls
                    controls.style.display = 'flex';
                    emptyState.style.display = 'none';
                    
                    // Update groups list
                    loadGroups();
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    alert('Could not access your camera and microphone. Please check permissions.');
                }
            }
        }
        
        function showLocalVideo() {
            // Remove empty state
            emptyState.style.display = 'none';
            
            // Create local video element
            const localVideoWrapper = document.createElement('div');
            localVideoWrapper.className = 'video-wrapper';
            localVideoWrapper.id = 'localVideoWrapper';
            
            const localVideo = document.createElement('video');
            localVideo.srcObject = localStream;
            localVideo.autoplay = true;
            localVideo.muted = true; // Mute local video to avoid echo
            
            const localLabel = document.createElement('div');
            localLabel.className = 'video-label';
            localLabel.textContent = 'You';
            
            localVideoWrapper.appendChild(localVideo);
            localVideoWrapper.appendChild(localLabel);
            
            videoContainer.appendChild(localVideoWrapper);
        }
        
        function handleUserJoined(userId, groupId) {
            if (currentGroup && currentGroup.id === groupId) {
                // Create a new peer connection for the joining user
                createPeerConnection(userId);
                
                // Send them an offer
                sendOffer(userId);
            }
        }
        
        function handleUserLeft(userId, groupId) {
            if (currentGroup && currentGroup.id === groupId) {
                // Remove the peer connection
                if (peers[userId]) {
                    peers[userId].close();
                    delete peers[userId];
                }
                
                // Remove their video element
                const remoteVideo = document.getElementById(`remoteVideo-${userId}`);
                if (remoteVideo) {
                    remoteVideo.remove();
                }
                
                // Update groups list
                loadGroups();
            }
        }
        
        function createPeerConnection(userId) {
            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            // Add local stream to connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Handle incoming stream
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                showRemoteVideo(userId, remoteStream);
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        to: userId,
                        groupId: currentGroup.id
                    }));
                }
            };
            
            peers[userId] = peerConnection;
            return peerConnection;
        }
        
        function showRemoteVideo(userId, stream) {
            // Create remote video element
            const remoteVideoWrapper = document.createElement('div');
            remoteVideoWrapper.className = 'video-wrapper';
            remoteVideoWrapper.id = `remoteVideo-${userId}`;
            
            const remoteVideo = document.createElement('video');
            remoteVideo.srcObject = stream;
            remoteVideo.autoplay = true;
            
            const remoteLabel = document.createElement('div');
            remoteLabel.className = 'video-label';
            remoteLabel.textContent = `User ${userId.substring(0, 6)}`;
            
            remoteVideoWrapper.appendChild(remoteVideo);
            remoteVideoWrapper.appendChild(remoteLabel);
            
            videoContainer.appendChild(remoteVideoWrapper);
        }
        
        async function sendOffer(toUserId) {
            const peerConnection = peers[toUserId];
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.send(JSON.stringify({
                type: 'offer',
                offer: offer,
                to: toUserId,
                groupId: currentGroup.id
            }));
        }
        
        async function handleOffer(offer, fromUserId) {
            if (!peers[fromUserId]) {
                createPeerConnection(fromUserId);
            }
            
            const peerConnection = peers[fromUserId];
            await peerConnection.setRemoteDescription(offer);
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                to: fromUserId,
                groupId: currentGroup.id
            }));
        }
        
        async function handleAnswer(answer, fromUserId) {
            const peerConnection = peers[fromUserId];
            await peerConnection.setRemoteDescription(answer);
        }
        
        async function handleIceCandidate(candidate, fromUserId) {
            const peerConnection = peers[fromUserId];
            await peerConnection.addIceCandidate(candidate);
        }
        
        function toggleAudio() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                
                isAudioMuted = !isAudioMuted;
                muteAudioBtn.classList.toggle('muted', isAudioMuted);
            }
        }
        
        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                
                isVideoMuted = !isVideoMuted;
                muteVideoBtn.classList.toggle('muted', isVideoMuted);
            }
        }
        
        async function leaveCall() {
            // Notify server we're leaving
            if (socket && socket.readyState === WebSocket.OPEN && currentGroup) {
                socket.send(JSON.stringify({
                    type: 'leave-group',
                    groupId: currentGroup.id
                }));
            }
            
            // Close all peer connections
            Object.values(peers).forEach(peer => {
                peer.close();
            });
            peers = {};
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                });
                localStream = null;
            }
            
            // Clear video container
            videoContainer.innerHTML = '';
            
            // Show empty state
            emptyState.style.display = 'block';
            controls.style.display = 'none';
            
            // Reset current group
            currentGroup = null;
            
            // Update groups list
            loadGroups();
            
            // Reset mute states
            isAudioMuted = false;
            isVideoMuted = false;
            muteAudioBtn.classList.remove('muted');
            muteVideoBtn.classList.remove('muted');
        }
        
        // Simulate initial groups (in a real app, this would come from the server)
        setTimeout(() => {
            const simulatedGroups = [
                { id: 'group1', name: 'Casual Chat', participants: ['user1', 'user2'] },
                { id: 'group2', name: 'Tech Talk', participants: ['user3'] },
                { id: 'group3', name: 'Music Lovers', participants: [] },
                { id: 'group4', name: 'Book Club', participants: ['user4', 'user5', 'user6'] }
            ];
            updateGroupsList(simulatedGroups);
        }, 1000);
    </script>
</body>
</html>